# ぷよぷよAI開発基盤プロジェクト仕様書

## プロジェクト概要

### 目的
ぷよぷよeスポーツSteam版の「ぷよぷよ通ルール」に準拠したAI開発基盤を構築する。エミュレータ方式（時間経過による自動落下なし）で実装し、様々なAIアルゴリズムを簡単に追加・比較できるプラットフォームを提供する。

### システム構成
- **C++**: ゲームエンジン、AIモデル（高速計算が必要な部分）
- **Python**: UI、ゲーム制御、設定管理、結果分析
- **連携**: pybind11による高効率なC++↔Python連携

### 対応モード
- **対戦モード**: AI vs AI、AI vs Human
- **とことんモード**: 一人プレイ（延々と連鎖を組み続ける練習・スコアアタック）

## ぷよぷよ通ルール仕様

### フィールド構造
- **メインフィールド**: 6列×14段
  - **可視部分**: 1段目～12段目（6列×12段）
  - **隠し段**: 13段目、14段目（画面外、非表示）
- **座標系**: 列番号1～6（左→右）、段番号1～14（下→上）
- **敗北判定**: 3列目の12段目（窒息点）にぷよが配置

### ぷよの基本仕様
- **色**: 4色（緑・赤・青・黄・紫の5色から1色除外）
- **操作ぷよ**: 2個のぷよで構成（軸ぷよ・子ぷよ）
- **回転**: 軸ぷよを中心とした4つの回転状態
- **連鎖条件**: 同色ぷよが4個以上隣接（上下左右）すると消去

### 14段目特殊仕様
- 各列でゲーム中1度だけ14段目に設置可能
- 14段目のぷよは自由落下ルールの対象外（落下しない）
- 同列への2回目以降の設置は不可
- 13段目と14段目を含めて4つ繋がってもぷよは消えない

### スコア計算システム

#### 基本計算式
```
得点 = 消したぷよの個数 × (連鎖ボーナス + 連結ボーナス + 色数ボーナス) × 10
```

#### 連鎖ボーナス表
| 連鎖数 | ボーナス値 | 連鎖数 | ボーナス値 |
|--------|------------|--------|------------|
| 1連鎖  | 0          | 8連鎖  | 160        |
| 2連鎖  | 8          | 9連鎖  | 192        |
| 3連鎖  | 16         | 10連鎖 | 224        |
| 4連鎖  | 32         | 11連鎖 | 256        |
| 5連鎖  | 64         | 12連鎖 | 288        |
| 6連鎖  | 96         | 13連鎖 | 320        |
| 7連鎖  | 128        | N連鎖  | 128 + 32×(N-7) |

#### 連結ボーナス表
| 連結数 | ボーナス値 | 連結数 | ボーナス値 |
|--------|------------|--------|------------|
| 4個    | 0          | 8個    | 5          |
| 5個    | 2          | 9個    | 6          |
| 6個    | 3          | 10個   | 7          |
| 7個    | 4          | 11個以上| 10         |

#### 色数ボーナス表
| 同時消し色数 | ボーナス値 |
|--------------|------------|
| 1色          | 0          |
| 2色          | 3          |
| 3色          | 6          |
| 4色          | 12         |
| 5色          | 24         |

#### 特例処理
- **1連鎖4個消し**: 本来0点だが例外的に40点
- **落下ボーナス**: 軸ぷよ1段につき1点 + 設置時1点（エミュレータでは仮想計算）
- **全消しボーナス**: 2,100点（次回連鎖時に加算）

### おじゃまぷよシステム
- **送信レート**: 70点につき1個のおじゃまぷよ
- **相殺システム**: 予告おじゃまぷよを自分の連鎖得点で相殺可能
- **おじゃまぷよ**: 色を持たず連鎖に参加しないが、隣接色ぷよ消去時に一緒に消える

### NEXT表示
- **2手先**まで表示（現在 + 次 + その次）

### ディレクトリ構成案

```
puyo-ai-platform/
├── cpp/                      # C++実装部分
│   ├── core/                 # ゲームエンジン
│   ├── ai/                   # AIモデル
│   ├── bindings/             # Python連携
│   └── CMakeLists.txt
├── python/                   # Python実装部分
│   ├── ui/                   # ユーザーインターフェース
│   ├── core/                 # Python制御層
│   ├── utils/                # ユーティリティ
│   └── bindings/             # C++連携
└── config/                   # 設定ファイル
```

## 実装要件

### C++コア部分（高速化対象）
- **ゲームエンジン**: ルール処理、フィールド操作
- **連鎖シミュレーション**: 高速計算（目標: 10,000回/秒以上）
- **AIモデル**: 探索型，強化学習型などを想定

### Python制御部分（柔軟性重視）
- **UI・描画**: pygame等による可視化
- **ゲーム制御**: 対戦管理、トーナメント制御
- **AI管理**: プラグイン型AI登録・作成システム
- **分析・ログ**: 結果分析、性能評価、可視化

### 連携仕様
- **pybind11**: C++↔Python高効率連携
- **データ変換**: GameState、Action等の相互変換
- **動的ライブラリ**: C++AIの動的ロード対応

## パフォーマンス要件

### ベンチマーク目標
- **連鎖シミュレーション**: 10,000回/秒以上
- **AI思考時間**: 1手あたり300ms以内
- **配置可能性判定**: 1ms以内
- **ゲーム状態コピー**: 1ms以内

### 最適化戦略
- フィールド上の計算をビット演算で実施
- 動的メモリ確保を削減

## 使用例

### 基本的な対戦実行
```python
import puyo_ai_platform as pap

# システム初期化
platform = pap.Platform()

# AI作成
ai1 = platform.create_ai('minimax', {'search_depth': 5})
ai2 = platform.create_ai('mcts', {'simulation_count': 1000})

# 対戦実行
result = platform.battle(ai1, ai2, rounds=100, render_realtime=True)

# 結果分析
platform.analyze_results(result)
```

### トーナメント実行
```python
# 複数AI準備
ais = [
    platform.create_ai('random'),
    platform.create_ai('minimax_depth3'),
    platform.create_ai('mcts_1000'),
    platform.create_ai('neural_network_v1'),
]

# トーナメント実行
tournament_result = platform.tournament(ais, rounds_per_match=50)
platform.generate_tournament_report(tournament_result)
```

## 拡張性

### AI追加の容易さ
- 統一インターフェースによる簡単なAI追加
- C++/Python両対応
- プラグイン型設計

### 将来の拡張
- 他ルール対応（フィーバーモード等）
- ネットワーク対戦
- 大規模分散計算
- Web UI対応

---

## TODO管理について

チケット内のTODOアイテムは以下の記法で管理します：

- `- [ ]`: 未完了のタスク
- `- [x]`: 完了したタスク

例：
```markdown
- [ ] 実装予定のタスク
- [x] 完了済みのタスク
```

実際に実施した内容について，チケットにまとめて記録します．

## テストの管理について

プロジェクトのテストは以下のように管理します：

### テストファイル管理
- テスト用ディレクトリ: `tests/`
- テストファイルは削除せずに`tests/`ディレクトリで保管
- 再現可能なテスト手順を文書化

### テスト結果記録
- 各チケットのテスト結果は`docs/test-results-XXX.md`に記録
- テスト実施方法、結果、環境情報を含める
- テストの再現手順を明記

---

*この仕様書は、ぷよぷよAI開発基盤の実装指針として、厳密なゲームルール再現と高性能な計算基盤の両立を目指します。C++による高速計算とPythonによる柔軟な制御の組み合わせにより、研究・実用の両方に対応できる強力なプラットフォームを提供します。