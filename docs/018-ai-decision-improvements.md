# チケット018: AI意思決定・エミュレータ操作に関する修正

## 概要

AI の意思決定システムとエミュレータ操作に関する以下の3つの改善を実装する：
1. AIDecision 構造体の設計変更
2. MoveCommand リスト生成アルゴリズムの実装
3. RandomAI の改修

## 実装内容

### 1. AIDecision 構造体の設計変更

現在の `AIDecision` は操作コマンド `MoveCommand` を含んでいるが、これを軸ぷよの列 `x` とその組ぷよの回転状態 `r` の組 `(x, r)` を基準とした設計に変更する。

新しい `AIDecision` の構造：
- `int x`: 軸ぷよの列（0-5）
- `int r`: 回転状態（0:UP, 1:RIGHT, 2:DOWN, 3:LEFT）
- `std::vector<MoveCommand> move_commands`: (x, r) へ到達するまでの操作コマンドリスト

### 2. MoveCommand リスト生成アルゴリズムの実装

#### 基本アルゴリズム

**基本的な移動パターン:**
- `x < 2` の場合: 軸ぷよの列が `x` になるまで左移動 → 回転状態 `r` になるまで回転
- `x > 2` の場合: 軸ぷよの列が `x` になるまで右移動 → 回転状態 `r` になるまで回転

**回転コマンド:**
- 右回転1回: UP → RIGHT
- 右回転2回: UP → DOWN  
- 左回転1回: UP → LEFT

#### 高度なアルゴリズム（12段制約対応）

移動途中の列 `l` に12段目までぷよが設置されている場合の特殊処理：

1. **到達可能な列の算出**
   - 2列目からスタートして1つずつ左移動してどの列も12段未満な列の集合
   - 2列目からスタートして1つずつ右移動してどの列も12段未満な列の集合
   - 上記2つの和集合が到達可能な列

2. **11段列を利用した迂回ルート**
   - 到達可能な列の中で11段の列が存在する場合、2列目に最も近いその11段の列 `l*` を選択
   
   **左移動で l* に到達した場合:**
   - 右回転を2回（UP → DOWN）
   - その後の方向調整:
     - `x < l*` の場合: 左回転を1回（DOWN → LEFT）
     - `x > l*` の場合: 右回転を1回（DOWN → RIGHT）
   
   **右移動で l* に到達した場合:**
   - 左回転を2回（UP → LEFT）
   - その後の方向調整:
     - `x < l*` の場合: 左回転を1回（LEFT → DOWN）
     - `x > l*` の場合: 右回転を1回（LEFT → UP）

3. **最終的な位置・回転調整**
   - 軸ぷよの列が `x` になるまで移動
   - 目標回転状態 `r` になるまで回転
   
   **x < 2 の場合（回転状態が右になっている）:**
   - 上にする: 左回転1回
   - 下にする: 右回転1回  
   - 左にする: 右回転2回
   - 右にする: 回転しない
   
   **x > 2 の場合（回転状態が左になっている）:**
   - 上にする: 右回転1回
   - 下にする: 左回転1回
   - 右にする: 左回転2回
   - 左にする: 回転しない

4. **最終落下操作**
   - 最後に落下操作 `MoveCommand::DROP` を追加

### 3. RandomAI の改修

現在の `RandomAI` をランダムな操作ではなく、配置可能なランダムな場所に組ぷよを配置するAIに変更する。

実装内容：
- 全ての配置可能な (x, r) の組み合わせを列挙（ `017-emulator-fixes.md` で作成した `can_place()` を活用）
- その中からランダムに1つ選択
- 上記のアルゴリズムを用いて MoveCommand リストを生成

## タスク一覧

- [ ] AIDecision 構造体の変更
  - [ ] 現在の AIDecision 構造を分析
  - [ ] 新しい構造体設計の実装
  - [ ] 関連するコードの修正
- [ ] MoveCommand リスト生成アルゴリズムの実装
  - [ ] 基本移動アルゴリズムの実装
  - [ ] 12段制約対応の高度なアルゴリズムの実装
  - [ ] 到達可能列算出ロジックの実装
  - [ ] 11段列利用迂回ルートの実装
  - [ ] 最終位置・回転調整ロジックの実装
- [ ] RandomAI の改修
  - [ ] 現在の RandomAI コードを分析
  - [ ] 配置可能位置列挙機能の実装
  - [ ] ランダム選択・MoveCommand 生成の実装
- [ ] テストの実装
  - [ ] AIDecision 構造体のテストケース作成
  - [ ] MoveCommand 生成アルゴリズムのテストケース作成
  - [ ] RandomAI のテストケース作成
  - [ ] 様々な盤面パターンでのテスト実行
- [ ] ドキュメント作成
  - [ ] テスト結果記録ファイル作成（test-results-018.md）
  - [ ] アルゴリズム詳細の記録
  - [ ] 実装内容の詳細記録

## 検収基準

1. AIDecision 構造体が (x, r) と MoveCommand リストを含む新しい設計になっていること
2. MoveCommand 生成アルゴリズムが全ての場合（基本パターン・12段制約対応）で正しく動作すること
3. RandomAI が配置可能な位置にランダムに組ぷよを配置できること
4. 生成された MoveCommand リストが実際に目標位置への移動を実現できること
5. 既存の AI システムとの互換性が保たれていること
6. 全てのテストケースが合格すること

## 備考

- アルゴリズムが複雑なため、段階的な実装とテストを推奨
- 12段制約の対応は特に慎重に実装・テストすること
- パフォーマンスを考慮し、効率的な実装を心がけること
- 既存のAIシステムとの統合時は互換性に注意すること

## 参考情報

### MoveCommand 列挙型
```cpp
enum class MoveCommand {
    LEFT,           // 左移動
    RIGHT,          // 右移動
    ROTATE_LEFT,    // 左回転
    ROTATE_RIGHT,   // 右回転
    DROP            // 落下
};
```

### 回転状態定義
- 0: UP (上向き)
- 1: RIGHT (右向き) 
- 2: DOWN (下向き)
- 3: LEFT (左向き)