# ぷよぷよ通ルール仕様

---

### フィールド構造
- **メインフィールド**: 6列×14段
  - **可視部分**: 1段目～12段目（6列×12段）
  - **隠し段**: 13段目、14段目（画面外、非表示）
- **座標系**: 列番号1～6（左→右）、段番号1～14（下→上）
- **敗北判定**: 3列目の12段目（窒息点）にぷよが配置

### ぷよの基本仕様
- **色**: 4色（緑・赤・青・黄・紫の5色から1色除外）
- **操作ぷよ**: 2個のぷよで構成（軸ぷよ・子ぷよ）
- **回転**: 軸ぷよを中心とした4つの回転状態
  - **キック**: ぷよを回転させようとしたとき，子ぷよが壁・床・他のぷよに接触している場合（回転時に子ぷよが壁・床・他のぷよにめり込む場合），軸ぷよの位置を1マスずらす
    - 左に壁・ぷよがある場合:
      - 上から反時計回り: x 方向に +1
      - 下から時計回り: x 方向に +1
    - 右に壁・ぷよがある場合:
      - 上から時計回り: x 方向に -1
      - 下から反時計回り: x 方向に -1
    - 左右両方に壁・ぷよがある場合:
      - クイックターンへ
    - 下に壁（＝床）・ぷよがある場合:
      - 右から時計回り: y 方向に +1
      - 左から反時計回り: y 方向に +1
  - **クイックターン**: 操作しているぷよの両側が壁になっているとき，回転操作を2回行なうと上下のぷよが反転（180度回転）する
    - 最初の回転操作ではぷよは回転せず，2つ目の回転操作ではじめて組ぷよの上下が反転する
- **連鎖条件**: 同色ぷよが4個以上隣接（上下左右）すると消去

### 14段目特殊仕様
- 各列でゲーム中1度だけ14段目に設置可能
- 14段目のぷよは自由落下ルールの対象外（落下しない）
- 同列への2回目以降の設置は不可
- 13段目と14段目を含めて4つ繋がってもぷよは消えない

### スコア計算システム

#### 基本計算式
```
得点 = 消したぷよの個数 × (連鎖ボーナス + 連結ボーナス + 色数ボーナス) × 10
```

#### 連鎖ボーナス表
| 連鎖数 | ボーナス値 | 連鎖数 | ボーナス値 |
|--------|------------|--------|------------|
| 1連鎖  | 0          | 8連鎖  | 160        |
| 2連鎖  | 8          | 9連鎖  | 192        |
| 3連鎖  | 16         | 10連鎖 | 224        |
| 4連鎖  | 32         | 11連鎖 | 256        |
| 5連鎖  | 64         | 12連鎖 | 288        |
| 6連鎖  | 96         | 13連鎖 | 320        |
| 7連鎖  | 128        | N連鎖  | 128 + 32×(N-7) |

#### 連結ボーナス表
| 連結数 | ボーナス値 | 連結数 | ボーナス値 |
|--------|------------|--------|------------|
| 4個    | 0          | 8個    | 5          |
| 5個    | 2          | 9個    | 6          |
| 6個    | 3          | 10個   | 7          |
| 7個    | 4          | 11個以上| 10         |

#### 色数ボーナス表
| 同時消し色数 | ボーナス値 |
|--------------|------------|
| 1色          | 0          |
| 2色          | 3          |
| 3色          | 6          |
| 4色          | 12         |
| 5色          | 24         |

#### 特例処理
- **1連鎖4個消し**: 本来0点だが例外的に40点
- **落下ボーナス**: 軸ぷよ1段につき1点 + 設置時1点（エミュレータでは仮想計算）
- **全消しボーナス**: 2,100点（次回連鎖時に加算）

### おじゃまぷよシステム
- **送信レート**: 70点につき1個のおじゃまぷよ
  - 連鎖スコアを70で割った余りについては，次の連鎖に繰り越される
    - 例：連鎖スコアが150点だった場合，150 = 70 * 2 + 10 となるため，2個のおじゃまぷよとあまりの10点が次のおじゃまぷよの個数の計算に用いられる．次の連鎖スコアが80点だった場合，10 + 80 = 90 = 70 * 1 + 20 となるため，1個のお邪魔ぷよとあまりの20点が次のおじゃまぷよの個数の計算に用いられる．
- **相殺システム**: 予告おじゃまぷよを自分の連鎖得点で相殺可能
  - おじゃまぷよが降るタイミングで相殺できなかった分のおじゃまぷよは，N 段 + r 個の形で上から降ってくる．
    - 例えば，20個のおじゃまぷよが降ってくる場合，フィールドの幅は6マスなので 20 = 6 * 3 + 2 より，3段＋2個のおじゃまぷよがフィールド上部から降ってくる．2個の部分については，ランダムな2列が選択される．
- **おじゃまぷよ**: 色を持たず連鎖に参加しないが、隣接色ぷよ消去時に一緒に消える

### NEXT表示
- **2手先**まで表示（現在 + 次 + その次）

## ディレクトリ構成案

```
puyo-ai-platform/
├── cpp/                      # C++実装部分
│   ├── core/                 # ゲームエンジン
│   ├── ai/                   # AIモデル
│   ├── bindings/             # Python連携
│   └── CMakeLists.txt
├── python/                   # Python実装部分
│   ├── ui/                   # ユーザーインターフェース
│   ├── core/                 # Python制御層
│   ├── utils/                # ユーティリティ
│   └── bindings/             # C++連携
└── config/                   # 設定ファイル
```
